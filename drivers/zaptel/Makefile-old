ifneq ($(KERNELRELEASE),)
obj-m := wcfxs.o
obj-m += zaptel.o
zaptel-objs := zaptel.o crc-ccitt.o 
wcfxs-objs := zaptel.o wcfxs.o

else
EXTRA_CFLAGS+=-DSTANDALONE_ZAPATA -DEXPORT_SYMTAB 
TZOBJS=zonedata.o tonezone.o
LIBTONEZONE=libtonezone.a
CFLAGS+=-I. -Wall -DBUILDING_TONEZONE 

CONFIG_FILE=/etc/zaptel.conf
CFLAGS+=-DZAPTEL_CONFIG=\"$(CONFIG_FILE)\"

KDIR=$(ROOTDIR)/linux-2.6.x
PWD=$(shell pwd)

all: apps zaptel
	

apps: libtonezone.a ztcfg

tones.h: gendigits
	./gendigits

gendigits: gendigits.o
	$(CC) -o gendigits gendigits.o -lm

zonedata.o: zonedata.c
	$(CC) $(CFLAGS) -c -o zonedata.o zonedata.c

tonezone.o: tonezone.c
	$(CC) $(CFLAGS) -c -o tonezone.o tonezone.c

libtonezone.a: $(TZOBJS)
	ar rcs libtonezone.a $(TZOBJS)

ztcfg.o: ztcfg.c
	$(CC) $(CFLAGS) -c -o ztcfg.o ztcfg.c

ztcfg: ztcfg.o libtonezone.a
	$(CC) $(CFLAGS) -Wl,-elf2flt -o ztcfg ztcfg.o libtonezone.a -lm   

clean:
	make -C $(KDIR) SUBDIRS=$(PWD) clean
	rm -f *.o *.ko *.lo gendigits tor2fw.h tones.h ztcfg

zaptel:
	$(MAKE) LDFLAGS="" -C $(KDIR) M=`pwd` modules

romfs:
	echo "Here, Jerry"
	rm -rf $(ROMFSDIR)/lib/modules/2.6.16.27-ADI-2006R2_pre/kernel/drivers/zaptel
	mkdir $(ROMFSDIR)/lib/modules/2.6.16.27-ADI-2006R2_pre/kernel/drivers/zaptel
	$(ROMFSINST) $(ROMFSDIR)/lib/modules/2.6.16.27-ADI-2006R2_pre/kernel/drivers/zaptel/wcfxs.o
	$(ROMFSINST) $(ROMFSDIR)/lib/modules/2.6.16.27-ADI-2006R2_pre/kernel/drivers/zaptel/zaptel.o
	cp ./zaptel.conf $(ROMFSDIR)/etc/
	
install:
	$(MAKE) -C $(KDIR) INSTALL_MOD_PATH=$(IDIR) \
	SUBDIRS=$(PWD) modules_install
endif

